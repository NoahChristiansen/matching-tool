



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0, mkdocs-material-3.0.3">
    
    
      
        <title>Modifying the Matching Service - Matching Tool</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../../#updating-the-matching-service" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Matching Tool" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Matching Tool
              </span>
              <span class="md-header-nav__topic">
                Modifying the Matching Service
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/dssg/matching-tool/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      Github
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Matching Tool" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Matching Tool
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/dssg/matching-tool/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      Github
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      For Users
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        For Users
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/using/" title="Using the Tool" class="md-nav__link">
      Using the Tool
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      Schemas
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        Schemas
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/schemas/booking-akaalias-data/" title="Booking AKA/Alias Schema" class="md-nav__link">
      Booking AKA/Alias Schema
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/schemas/booking-charging-data/" title="Booking Charge Schema" class="md-nav__link">
      Booking Charge Schema
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/schemas/booking-data/" title="Booking Schema" class="md-nav__link">
      Booking Schema
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/schemas/by-name-list/" title="By-Name Schema" class="md-nav__link">
      By-Name Schema
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/schemas/case-charge-data/" title="Case Charge Schema" class="md-nav__link">
      Case Charge Schema
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/schemas/hmis-akaalias-data/" title="Homelessness Services AKA/Alias Schema" class="md-nav__link">
      Homelessness Services AKA/Alias Schema
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../users/schemas/hmis-data/" title="Homelessness Service Stays Schema" class="md-nav__link">
      Homelessness Service Stays Schema
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      For Administrators
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        For Administrators
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/install/" title="Installing" class="md-nav__link">
      Installing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/troubleshooting/" title="Troubleshooting" class="md-nav__link">
      Troubleshooting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/updating/" title="Updating" class="md-nav__link">
      Updating
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../admin/matching/" title="Configuring the Matching Service" class="md-nav__link">
      Configuring the Matching Service
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      For Developers
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        For Developers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../schemas/" title="Creating or Modifying a Schema" class="md-nav__link">
      Creating or Modifying a Schema
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../webapp/" title="Modifying the Webapp" class="md-nav__link">
      Modifying the Webapp
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Modifying the Matching Service
      </label>
    
    <a href="./" title="Modifying the Matching Service" class="md-nav__link md-nav__link--active">
      Modifying the Matching Service
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#updating-the-matching-service" title="Updating the Matching Service" class="md-nav__link">
    Updating the Matching Service
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview-of-the-matching-process" title="Overview of the Matching Process" class="md-nav__link">
    Overview of the Matching Process
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-adjustments-to-the-matcher" title="Common Adjustments to the Matcher" class="md-nav__link">
    Common Adjustments to the Matcher
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-or-increasing-use-of-a-data-field" title="Adding or Increasing Use of a Data Field" class="md-nav__link">
    Adding or Increasing Use of a Data Field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removing-or-decreasing-use-of-a-data-field" title="Removing or Decreasing Use of a Data Field" class="md-nav__link">
    Removing or Decreasing Use of a Data Field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stopping-the-matcher-from-caching-so-many-files" title="Stopping the Matcher from Caching so Many Files" class="md-nav__link">
    Stopping the Matcher from Caching so Many Files
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#updating-the-matching-service" title="Updating the Matching Service" class="md-nav__link">
    Updating the Matching Service
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview-of-the-matching-process" title="Overview of the Matching Process" class="md-nav__link">
    Overview of the Matching Process
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-adjustments-to-the-matcher" title="Common Adjustments to the Matcher" class="md-nav__link">
    Common Adjustments to the Matcher
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-or-increasing-use-of-a-data-field" title="Adding or Increasing Use of a Data Field" class="md-nav__link">
    Adding or Increasing Use of a Data Field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removing-or-decreasing-use-of-a-data-field" title="Removing or Decreasing Use of a Data Field" class="md-nav__link">
    Removing or Decreasing Use of a Data Field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stopping-the-matcher-from-caching-so-many-files" title="Stopping the Matcher from Caching so Many Files" class="md-nav__link">
    Stopping the Matcher from Caching so Many Files
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/dssg/matching-tool/edit/master/docs/dev/matching.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Modifying the Matching Service</h1>
                
                <h2 id="updating-the-matching-service">Updating the Matching Service<a class="headerlink" href="#updating-the-matching-service" title="Permanent link">&para;</a></h2>
<p>Modifying the matching service is neccesary if you would like to change or improve matching results, experiment on matching algorithm configurations, speed up the matching process, or make other changes to how matching is done. This document provides an overview of the matching process (including how to configure the specific steps using the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher_config.yaml">matcher configuration file</a>), and guidelines on how to make changes under common circumstances.</p>
<h3 id="overview-of-the-matching-process">Overview of the Matching Process<a class="headerlink" href="#overview-of-the-matching-process" title="Permanent link">&para;</a></h3>
<p>When a user successfully uploads a new data file to the webapp, the webapp calls <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/tasks.py#L28">do_match()</a> to begin a new matching job, instructing the matcher about which files to match and where to find them. From this point, the matching process proceeds like this:</p>
<ol>
<li>
<p><strong>Load and combine event data:</strong> <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/ioutils.py#L42">load_data_for_matching()</a> loads and combines into a single data frame all of the data files passed by the webtool, retaining only the columns specified in the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher_config.yaml#L1">keys</a> section of the matcher configuration file. This section of the configuration file is a simple list, where each line should begin with a <code>-</code> and contain the name of a column that is shared by <em>all</em> of the schemas to be matched:</p>
<pre><code>keys:
    # Which columns to select for matching
    - first_name
    - middle_name
    - last_name
    - dob
    - ssn
    - dmv_number
    - dmv_state
    - race
    - ethnicity
    - sex
</code></pre>
</li>
<li>
<p><strong>Exact deduplication:</strong> Before beginning the algorithmic matching process, we <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/ioutils.py#L64">drop all rows that are exact duplicates</a> of another row on the matching keys (e.g., match exactly on first name, last name, date of birth, social security number, gender, and race).</p>
</li>
<li>
<p><strong>Preprocessing:</strong> The deduplicated data are then sent to <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/preprocess.py">preprocess.py</a> to be cleaned and to enforce data types. Any data cleaning rules (e.g., cleaning out punctuation from strings, removing white space, converting data types) should be added to this file.</p>
</li>
<li>
<p><strong>Record linkage:</strong> From here, the matching algorithm proceeds by breaking the data into smaller subsets (blocking), generating contrasts on each of these subsets, and then clustering records into matched groups using a split-apply-combine methodology. Each of these steps is described below.</p>
<ul>
<li>
<p><strong>Blocking:</strong> Comparing all records to each other is wasteful. Most record pairs are not true matches. We can identify subsets of record pairs that are more likely to contain matches and only make comparisons on them, saving both computation time and memory. The matcher uses <em>blocking</em> to do this, <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/matcher.py#L33">subsetting</a> the records into a dictionary smaller dataframes based on the the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher_config.yaml#L14">blocking keys</a> in the matcher configuration file. Blocking rules should be entered as a dictionary of key-value pairs, where each key is a name of a column, and each value is the number of characters to use for blocking. For example, the rule <code>dob: 3</code> includes all people who share the first three "letters" of their date of birth (i.e., their decade of birth when dates are in YYYY-MM-DD format) in the same block. Records are only compared to each other if they share values on <strong>all</strong> of the keys. </p>
<pre><code>blocking_rules:
    last_name: 2
    dob: 3
    first_name: 1
</code></pre>
</li>
<li>
<p><strong>Indexing:</strong> Blocks with a single record will be <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/matcher.py#L44">assigned a unique matched id</a> and skip the remaining matching steps. For each block with more than one record, the matcher <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/matcher.py#L67">identifies all <em>unique</em> record pairs</a>. If the block includes Jon, Jane, and Joe, it will compare Jon with Jane, Jon with Joe, and Jane with Joe, but it will ignore self-comparisons like Jon with Jon or duplicate comparisons like Jane with Jon.</p>
</li>
<li>
<p><strong>Contrasting:</strong> Next, the matcher will use the contraster compare the records' values on the preprocessed columns (e.g., how different are the first names in a pair of records?). The <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/contraster.py#L42">contraster</a> contains several methods for making comparisons on a column in the preprocessed data. Several methods are wrappers for contrast methods available in the <a href="https://pypi.org/project/recordlinkage/"><code>recordlinkage</code></a> package. New types of contrasts can be created by adding methods to the contraster.</p>
<p><a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher_config.yaml#L24">Configuring the contrasts</a> is a matter of specifying in a dictionary which methods you would like to call on each preprocessed column, and what arguments, if any, you would like to pass to that method. The top level keys are the names of the preprocessed columns you want to make comparisons on. The values for these keys are lists of dictionaries with the keys <code>method</code> and <code>args</code> (optional, a dictionary of arguments to be passed to the named method). Each <code>method</code>/<code>args</code> pair should be preceded by a <code>-</code> to indicate that it is an item in the list. The following configuration will make three contrasts on the <code>first_name</code> field (do the first names match exactly? do the first names have exactly the same first 5 letters? how far apart are the first names using the <a href="https://en.wikipedia.org/wiki/Jaro%E2%80%93Winkler_distance">Jaro-Winkler metric</a>?) and two comparisons on the <code>race</code> field (do the two records share any races? do they share all of their races?):</p>
<pre><code>contrasts:
    first_name:
        - method: compare_exact 
        - method: compare_exact 
          args:
               n_chars: 5
        - method: compare_string_distance
          args:
               method: jarowinkler
    race:
        - method: compare_list
          args:
               method: any
        - method: compare_list
          args:
               method: all
</code></pre>
<p>It is important to note here that including a column in the <em>keys</em> section of the configuration will ensure that it is used for exact deduplication in step 2, but if you would like it to be used in the record linkage process, you must include one or more contrasts on that column. In addition, if you rename a column or create a new column in any changes to the preprocessing step, you will need to add a key and contrasts for that column to the contrasts section of the configuration file.</p>
</li>
<li>
<p><strong>Scoring:</strong> The contrasts step creates many different comparisons for a pair of records; the scoring step combines all of these comparisons into a single distance score that summarizes how different the two records are, with lower scores indicating more similar records. The matcher has several options for scoring when it calls the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/rules.py#L18"><code>compactify()</code></a> function. The default in the matcher itself is to take the simple mean of all of the contrast values. This can be changed by changed the <code>operation</code> parameter <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/rules.py#L18">when the <code>compactify()</code> function is called</a> and/or by adding new operations to the <code>compactify()</code> function.</p>
</li>
<li>
<p><strong>Clustering and assigning matched_ids:</strong> To determine which groups of records belong to a single person, the matcher uses a <a href="https://en.wikipedia.org/wiki/Cluster_analysis">clustering algorithm</a>. Which algorithm it uses and the hyperparameters of the algorithm are specified in the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher_config.yaml#L101">clusterer section of the matcher config</a>. This section should contain an installed <code>method</code> as a top level key and a dictionary of <code>args</code> to pass to that method. </p>
<pre><code>clusterer:
    method: sklearn.cluster.DBSCAN
    args:
        eps: 0.2
        min_samples: 1
        algorithm: auto
        leaf_size: 30
        n_jobs: 4
</code></pre>
<p>The matcher has only been tested with <a href="http://scikit-learn.org/stable/modules/generated/sklearn.cluster.DBSCAN.html">scikit-learn's implementation of DBSCAN</a> and will not work with any other method without making code changes to the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/cluster.py">clusterer</a>.</p>
</li>
</ul>
</li>
<li>
<p><strong>Saving results and notifying the webapp:</strong> Once the record linkage step is done, the matcher has a dataframe of deduplicated and matched records. To <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/ioutils.py#L111">complete its output</a>, it re-loads the original source data and joins the matched ids to each table's primary key, writing the results to a file named <code>matched</code> in the same directory as the merged data it received from the webapp. It then notifies the webapp that its job is complete, so the webapp can upload the new matched_ids to the database and make the results available to end users.</p>
</li>
</ol>
<h3 id="common-adjustments-to-the-matcher">Common Adjustments to the Matcher<a class="headerlink" href="#common-adjustments-to-the-matcher" title="Permanent link">&para;</a></h3>
<h4 id="adding-or-increasing-use-of-a-data-field">Adding or Increasing Use of a Data Field<a class="headerlink" href="#adding-or-increasing-use-of-a-data-field" title="Permanent link">&para;</a></h4>
<p>If you would like to add a new field to the matcher algorithm, you will need to add it in multiple places in the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher_config.yaml">matcher configuration file</a>. The column name should be listed as a key in the <code>keys</code> section of the configuration file. This will cause it to be used for exact deduplication and to be included in the data sent to the matcher algorithm. You may also wish to add <a href="https://github.com/dssg/matching-tool/blob/81ed73ba55dc4a6bccbce789325ca8c0a47c8684/matcher/matcher/preprocess.py">pre-processing steps</a> to reformat the data before matching. To compare records on this field in the matcher, you will need to add contasts to the <code>contrasts</code> section of the configuration file. </p>
<p>Because the default behavior of the matcher when it calls the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/rules.py#L18"><code>compactify()</code></a> function is to take a simple average of the contrasts, adding more contrasts for a field adds more weight to that field. For example, in the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher_config.yaml">default configuration file</a>, there are six comparisons for first name but only one comparison for middle name, meaning that the matcher weights the first name six times as strongly as the middle name. If we wanted to weight middle name higher, we could add additional contrasts on the middle name, such as examining the Jaro-Winkler distance between the middle names in a pair of records. Note that if you add the same contrast multiple times for a single data field, they will overwrite each other rather than being used multiple times. You can see what a newly added contrast looks like and how it affects the scores by examining the cached contrasts in the <code>match_cache/contrasts</code> folder in the jurisdiction's root storage directory.</p>
<p>Manually assigning weights to each contrast would require code changes to the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/rules.py#L18"><code>compactify()</code></a> function to support weighting (and to allow for user input of weighting).</p>
<h4 id="removing-or-decreasing-use-of-a-data-field">Removing or Decreasing Use of a Data Field<a class="headerlink" href="#removing-or-decreasing-use-of-a-data-field" title="Permanent link">&para;</a></h4>
<p>If you would like to remove a field from the matcher algorithm completely, you will need to remove it from both the <code>keys</code> and the <code>contrasts</code> sections of the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher_config.yaml">matcher configuration file</a>. The column name should be listed as a key in the <code>keys</code> section of the configuration file.</p>
<p>If you simply would like decrease how much that matcher uses the data field, you should remove contrasts for that field. Because the default behavior of the matcher when it calls the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/rules.py#L18"><code>compactify()</code></a> function is to take a simple average of the contrasts, removing some of the contrasts for a field will decrease the weight to that field. For example, in the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher_config.yaml">default configuration file</a>, there are six comparisons for first name but only one comparison for middle name, meaning that the matcher weights the first name six times as strongly as the middle name. If we wanted to decrease the relative weight of the first name, we could remove contrasts on the first name, such as only comparing the exact first name and its Jaro-Winkler distance. Then, first name would only be counted twice as much as middle name. However, we would also have changed <em>how</em> we use first name by discregarding partial string comparisons on the first and last 3 and 5 letters. You can see how this change affects the scores by examining the cached contrasts in the <code>match_cache/contrasts</code> folder in the jurisdiction's root storage directory.</p>
<p>Manually assigning weights to each contrast would require code changes to the <a href="https://github.com/dssg/matching-tool/blob/master/matcher/matcher/rules.py#L18"><code>compactify()</code></a> function to support weighting (and to allow for user input of weighting).</p>
<h4 id="stopping-the-matcher-from-caching-so-many-files">Stopping the Matcher from Caching so Many Files<a class="headerlink" href="#stopping-the-matcher-from-caching-so-many-files" title="Permanent link">&para;</a></h4>
<p>The matcher stores a lot of information in its cache to allow you to diagnose problems and test how changes to the configuration affect different stages of the process (e.g., what does a newly added contrast look like? how does it affect the scores?). These are stored in the <code>match_cache</code> folder in your base directory. This folder can be occasionally cleared to remove the backlog of files.</p>
<p>If you find the space used by the matcher excessive, or if you are not making changes to the matching algorithm that you want to test, you may want to disable much of this caching. To do this remove or comment out the lines in the matcher where it writes these files to disk using the <code>write_dataframe()</code> function:</p>
<ul>
<li><a href="https://github.com/dssg/matching-tool/blob/81ed73ba55dc4a6bccbce789325ca8c0a47c8684/matcher/matcher/cluster.py#L73">cluster.py</a> caches the squared distance matrix and the raw cluster ids for each block, so there are two lines to remove.</li>
<li><a href="https://github.com/dssg/matching-tool/blob/81ed73ba55dc4a6bccbce789325ca8c0a47c8684/matcher/matcher/matcher.py#L83">matcher.py</a> caches the contrasts for each block.</li>
<li><a href="https://github.com/dssg/matching-tool/blob/0dac113cb1652c956c2e7358cd1e6163ca7aff25/matcher/matcher/ioutils.py#L73">ioutils.py</a> caches the loaded, deduplicated data.</li>
<li><a href="https://github.com/dssg/matching-tool/blob/81ed73ba55dc4a6bccbce789325ca8c0a47c8684/matcher/matcher/preprocess.py#L83">preprocess.py</a> caches the preprocessed data to allow you to examine the affect of preprocessing on the raw data.</li>
</ul>
<p><strong>Note:</strong> Only remove <code>write_dataframe()</code> calls writing to the <code>match_cache</code>. Other writes are critical to the function of the matching tool.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../webapp/" title="Modifying the Webapp" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Modifying the Webapp
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>